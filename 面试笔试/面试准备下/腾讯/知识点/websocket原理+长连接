### 2.1 Http连接

**Http协议**，即超文本传输协议，是Web联网的基础。Http协议是建立在TCP协议之上的一种应用。Http协议负责如何包装数据，而TCP协议负责如何传输数据。因此，如果只有TCP协议，那么将无法解析传输过来的数据。

HTTP连接最显著的特点**是客户端发送的每次请求都需要服务器回送响应，在请求结束后，会主动释放连接**。从建立连接到关闭连接的过程称为“一次连接”。

1）在HTTP 1.0中，客户端的每次请求都要求建立一次单独的连接，在处理完本次请求后，就自动释放连接，这是一种“短连接”。

2）在HTTP 1.1中则可以在一次连接中处理多个请求，并且多个请求可以重叠进行，不需要等待一个请求结束后再发送下一个请求，这是一种“长连接”。在Http 1.1 中只需要在请求头配置`keep-alive : true`即可实现长连接。此时，服务端返回的请求头中会有 `connection : keep-alive` 表明这是一个长连接。

### 2.2 TCP连接

手机能够使用联网功能是因为手机底层实现了TCP/IP协议，**可以使手机终端通过无线网络建立TCP连接**。TCP协议可以对上层网络提供接口，使上层网络数据的传输建立在“无差别”的网络之上。

---

## 2.3 Socket连接

**2.3.1 Socket的定义**

Socket，即套接字，是支持TCP/IP协议的网络通信的基本操作单元。它是**网络通信过程中端点的抽象表示**，包含进行网络通信必须的五种信息：连接使用的协议，本地主机的IP地址，本地进程的协议端口，远地主机的IP地址，远地进程的协议端口。

应用层通过传输层进行数据通信时，TCP会遇到同时为多个应用程序进程提供并发服务的问题。多个TCP连接或多个应用程序进程可能需要通过同一个 TCP协议端口传输数据。为了区别不同的应用程序进程和连接，**许多计算机操作系统为应用程序与TCP／IP协议交互提供了套接字(Socket)接口**。应用层可以和传输层通过Socket接口，区分来自不同应用程序进程或网络连接的通信，实现数据传输的并发服务。

**2.3.2 Socket连接**

建立Socket连接至少需要一对套接字，其中一个运行于客户端，称为ClientSocket ，另一个运行于服务器端，称为ServerSocket 。

套接字之间的连接过程分为三个步骤：服务器监听，客户端请求，连接确认。

- 服务器监听：服务器端套接字并不定位具体的客户端套接字，而是处于等待连接的状态，实时监控网络状态，等待客户端的连接请求。
- 客户端请求：指客户端的套接字提出连接请求，要连接的目标是服务器端的套接字。为此，客户端的套接字必须首先描述它要连接的服务器的套接字，指出服务器端套接字的地址和端口号，然后就向服务器端套接字提出连接请求。
- 连接确认：当服务器端套接字监听到或者说接收到客户端套接字的连接请求时，就响应客户端套接字的请求，建立一个新的线程，把服务器端套接字的描述发给客户端，一旦客户端确认了此描述，双方就正式建立连接。而服务器端套接字继续处于监听状态，继续接收其他客户端套接字的连接请求。

### 2.4 Socket连接和TCP连接的关系

创建Socket连接时，可以指定使用的传输层协议，Socket可以支持不同的传输层协议（TCP或UDP），当**使用TCP协议进行连接时，该Socket连接就是一个TCP连接**。

> 总结：socket是对TCP/IP协议的封装和应用（程序员层面上）,它提供了一组基本的函数接口（比如：create、listen、accept等），使得程序员更方便地使用TCP/IP协议栈。

> TCP/IP只是一个协议栈，就像操作系统的运行机制一样，必须要具体实现，同时还要提供对外的操作接口。

### 2.5 Socket连接和Http连接的关系

Socket连接一般情况下都是TCP连接，因此Socket连接一旦建立，通信双方就可以进行**互相发送内容**。但在实际网络应用中，客户端到服务器之间的通信往往需要穿越多个中间节点，例如路由器、网关、防火墙等，大部分防火墙默认会关闭长时间处于非活跃状态的连接而导致 Socket 连接断连，因此需要通过轮询告诉网络，该连接处于活跃状态。（**这也就是常说的“心跳策略”**）

Http连接是**“请求-响应”**的方式，不仅在请求时需要先建立连接，而且需要客户端向服务器发出请求后，服务器端才能回复数据。

> 总结：如果建立的是Socket连接，服务器可以直接将数据传送给客户端；如果方建立的是HTTP连接，则服务器需要等到客户端发送一次请求后才能将数据传回给客户端。

> 总结
>
> websocket的原理，就是通过tcp来传送客户端和服务端直接的套接字，
>
> 建立Socket连接至少需要一对套接字，其中一个运行于客户端，称为ClientSocket ，另一个运行于服务器端，称为ServerSocket 。
>
> 因为路由器网关等中间节点会默认关闭长时间处于非活跃状态的链接，导致socket断链接，所以需要经常轮询保持活跃，心跳策略
>
> 指出服务器端套接字的地址和端口号

**如何判断网络状态稳定？**

> 答：使用 短心跳连续成功三次，此时认为网络相对稳定。

---

## webpush原理

### 8.1 WhatsApp的Push策略



![img](https://user-gold-cdn.xitu.io/2018/5/20/1637c821b5ddf162?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



### 8.2 Line的Push策略



![img](https://user-gold-cdn.xitu.io/2018/5/20/1637c8e020876c4d?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



### 8.3 微信的Push策略

微信没有使用GCM，自己维护TCP长连接，使用固定心跳。

心跳典型值为：



![img](https://user-gold-cdn.xitu.io/2018/5/20/1637c8fb54288694?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

---

里面有大学问：可以好好研究下，学习下

计算机网络的边缘

https://cloud.tencent.com/developer/article/1030660

可以好好研究下